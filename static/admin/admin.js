let authed=false;const elLoginWrap=document.getElementById('loginWrap'),elPanelWrap=document.getElementById('panelWrap'),elLoginMsg=document.getElementById('loginMsg'),elCatList=document.getElementById('catList'),elProdList=document.getElementById('prodList'),elCatTpl=document.getElementById('catTpl'),elProdTpl=document.getElementById('prodTpl');async function login(){const pass=document.getElementById('pass').value;const r=await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pass})}).then(r=>r.json());if(r.ok){authed=true;elLoginWrap.classList.add('hidden');elPanelWrap.classList.remove('hidden');await refreshAll();}else{elLoginMsg.textContent='Неверный пароль';}}async function logout(){await fetch('/api/admin/logout',{method:'POST'});location.reload();}async function refreshAll(){await Promise.all([loadCatsAdmin(),loadProdsAdmin()]);fillCatSelects();}async function loadCatsAdmin(){const r=await fetch('/api/admin/categories').then(r=>r.json());elCatList.innerHTML='';(r.data||[]).forEach(c=>{const node=elCatTpl.content.firstElementChild.cloneNode(true);const name=node.querySelector('.catName');name.value=c.name;node.querySelector('.save').onclick=async()=>{await fetch(`/api/admin/categories/${c.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name.value})});await refreshAll();};node.querySelector('.del').onclick=async()=>{if(confirm('Удалить категорию?')){await fetch(`/api/admin/categories/${c.id}`,{method:'DELETE'});await refreshAll();}};elCatList.appendChild(node);});}async function loadProdsAdmin(){const r=await fetch('/api/admin/products').then(r=>r.json());elProdList.innerHTML='';(r.data||[]).forEach(p=>{const node=elProdTpl.content.firstElementChild.cloneNode(true);node.querySelector('.thumb').style.backgroundImage=`url(${p.image_url||''})`;const name=node.querySelector('.pName');name.value=p.name;const price=node.querySelector('.pPrice');price.value=p.price;const img=node.querySelector('.pImg');img.value=p.image_url||'';const desc=node.querySelector('.pDesc');desc.value=p.description||'';const avail=node.querySelector('.pAvail');avail.checked=!!p.available;const select=node.querySelector('.pCat');select.dataset.selected=p.category_id||'';node.querySelector('.save').onclick=async()=>{await fetch(`/api/admin/products/${p.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name.value,price:+price.value,category_id:+select.value||null,image_url:img.value,description:desc.value,available:avail.checked})});await refreshAll();};node.querySelector('.del').onclick=async()=>{if(confirm('Удалить товар?')){await fetch(`/api/admin/products/${p.id}`,{method:'DELETE'});await refreshAll();}};elProdList.appendChild(node);});}async function fillCatSelects(){const cats=await fetch('/api/admin/categories').then(r=>r.json()).then(x=>x.data||[]);const pCat=document.getElementById('pCat');pCat.innerHTML='<option value="">Без категории</option>'+cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');document.querySelectorAll('.pCat').forEach(sel=>{sel.innerHTML='<option value="">Без категории</option>'+cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');if(sel.dataset.selected) sel.value=sel.dataset.selected;});}async function addCategory(){const name=document.getElementById('newCatName').value.trim();if(!name) return;await fetch('/api/admin/categories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});document.getElementById('newCatName').value='';await refreshAll();}async function addProduct(){const name=document.getElementById('pName').value.trim();const price=+document.getElementById('pPrice').value;const category_id=+document.getElementById('pCat').value||null;const image_url=document.getElementById('pImg').value.trim();const description=document.getElementById('pDesc').value.trim();const available=document.getElementById('pAvail').checked;if(!name||isNaN(price)){alert('Название и цена обязательны');return;}await fetch('/api/admin/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,price,category_id,image_url,description,available})});['pName','pPrice','pImg','pDesc'].forEach(id=>document.getElementById(id).value='');document.getElementById('pAvail').checked=true;await refreshAll();}window.login=login;window.logout=logout;window.addCategory=addCategory;window.addProduct=addProduct;