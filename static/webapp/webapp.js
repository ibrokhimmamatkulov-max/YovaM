const tg=window.Telegram?.WebApp; if(tg) tg.expand(); let CATEGORIES=[],PRODUCTS=[],cart=[]; const elCats=document.getElementById('categories'),elGrid=document.getElementById('products'),elCartBar=document.getElementById('cartBar'),elCartCount=document.getElementById('cartCount'),elCartTotal=document.getElementById('cartTotal'),elOrder=document.getElementById('orderBtn'); function fmt(n){return (Math.round(n*100)/100).toString().replace('.',',')} async function loadData(){const cats=await fetch('/api/categories/public').then(r=>r.json()); const prods=await fetch('/api/products/public').then(r=>r.json()); if(cats.ok) CATEGORIES=cats.data; if(prods.ok) PRODUCTS=prods.data; renderCategories(); renderProducts(); } function renderCategories(){elCats.innerHTML=''; const allBtn=createTab('Все',true); elCats.appendChild(allBtn); CATEGORIES.forEach(c=>{const t=createTab(c.name,false,c.id); elCats.appendChild(t);}); } function createTab(title,active=false,id=null){const a=document.createElement('button'); a.className='tab'+(active?' active':''); a.textContent=title; a.dataset.catId=id; a.onclick=()=>{document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active')); a.classList.add('active'); renderProducts(id);}; return a;} function renderProducts(catId=null){elGrid.innerHTML=''; let list=PRODUCTS; if(catId) list=PRODUCTS.filter(p=>p.category_id===catId); const tpl=document.getElementById('productCardTpl'); list.forEach(p=>{const node=tpl.content.firstElementChild.cloneNode(true); node.querySelector('.card-img').src=p.image_url||''; node.querySelector('.card-title').textContent=p.name; node.querySelector('.card-desc').textContent=p.description||''; node.querySelector('.price').textContent=fmt(p.price)+' TJS'; node.querySelector('.add-btn').onclick=()=>addToCart(p); elGrid.appendChild(node);}); } function addToCart(p){const ex=cart.find(i=>i.id===p.id); if(ex) ex.qty+=1; else cart.push({id:p.id,name:p.name,price:p.price,qty:1}); updateCartBar(); } function updateCartBar(){const count=cart.reduce((a,b)=>a+b.qty,0); const total=cart.reduce((a,b)=>a+b.qty*b.price,0); elCartCount.textContent=count; elCartTotal.textContent=fmt(total); elCartBar.classList.toggle('hidden',count===0);} elOrder.onclick=()=>{if(!cart.length) return; const total=cart.reduce((a,b)=>a+b.qty*b.price,0); const payload={type:'order',payload:{items:cart,total}}; if(tg?.sendData){tg.sendData(JSON.stringify(payload)); tg.close();} else {alert('Откройте через Telegram чтобы оформить заказ.');}}; window.openAdmin=()=>{ if(tg?.openLink) tg.openLink(location.origin+'/admin'); else window.open('/admin','_blank'); }; loadData();